<!-- status autogenerated section -->
# Azure Event Hub Receiver
| Status        |           |
| ------------- |-----------|
| Stability     | [beta]: metrics, logs, traces   |
| Distributions | [contrib] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Areceiver%2Fazureeventhub%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Areceiver%2Fazureeventhub) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Areceiver%2Fazureeventhub%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Areceiver%2Fazureeventhub) |
| Code coverage | [![codecov](https://codecov.io/github/open-telemetry/opentelemetry-collector-contrib/graph/main/badge.svg?component=receiver_azure_event_hub)](https://app.codecov.io/gh/open-telemetry/opentelemetry-collector-contrib/tree/main/?components%5B0%5D=receiver_azure_event_hub&displayType=list) |
| [Code Owners](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/CONTRIBUTING.md#becoming-a-code-owner)    | [@atoulme](https://www.github.com/atoulme), [@cparkins](https://www.github.com/cparkins), [@dyl10s](https://www.github.com/dyl10s) \| Seeking more code owners! |
| Emeritus      | [@djaglowski](https://www.github.com/djaglowski) |

[beta]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#beta
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
<!-- end autogenerated section -->

## Overview

Azure resources and services can be
[configured](https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/diagnostic-settings)
to send their telemetry to an Azure Event Hub. The Azure Event Hub receiver pulls telemetry from an Azure
Event Hub, transforms them, and pushes them through the collector pipeline.

### Read further

* [Diagnostic settings in Azure Monitor](https://learn.microsoft.com/en-us/azure/azure-monitor/platform/diagnostic-settings?tabs=portal)
* [Stream Azure monitoring data to an event hub and external partner](https://learn.microsoft.com/en-us/azure/azure-monitor/platform/stream-monitoring-data-event-hubs)

## Configuration

### Connection Settings

Either `connection` or `auth` must be specified.

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| `connection` | string | Yes* | | Connection string from the Azure portal. Ignored if `auth` is set. |
| `auth` | string | Yes* | | ID of an authentication extension (AAD, managed identity, or service principal). |
| `event_hub.name` | string | ** | | Event Hub name. Required when using `auth`. |
| `event_hub.namespace` | string | ** | | Fully qualified namespace (e.g., `namespace.servicebus.windows.net`). Required when using `auth`. |

\* One of `connection` or `auth` is required.  
\** Required when using `auth`.

### Consumer Settings

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| `group` | string | No | `$Default` | Consumer group to read from. |
| `partition` | string | No | `""` | Specific partition to watch. If empty, watches all partitions. |
| `offset` | string | No | `""` | Starting offset. Only applicable when `partition` is set. |
| `storage` | string | No | | ID of a [storage extension] for checkpoint persistence. |

### Polling Settings

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| `max_poll_events` | int | No | `100` | Maximum events to retrieve per poll. |
| `poll_rate` | int | No | `5` | Maximum seconds to wait before returning fewer than `max_poll_events`. |

### Data Transformation Settings

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| `format` | string | No | `azure` | Message format: `azure`, `raw`, or `""`. See [Format](#format) section. |
| `apply_semantic_conventions` | bool | No | `false` | Translate Azure Resource Logs using OpenTelemetry semantic convention attribute names. |
| `time_formats.logs` | []string | No | | Custom time formats for logs. Uses [Go time layout](https://pkg.go.dev/time#Layout). Falls back to ISO8601. |
| `time_formats.metrics` | []string | No | | Custom time formats for metrics. |
| `time_formats.traces` | []string | No | | Custom time formats for traces. |
| `metric_aggregation` | string | No | | Set to `average` to aggregate datapoints as `sum/count`. By default, creates separate metrics with suffixes (`_TOTAL`, `_MIN`, etc.). |

### Example Configuration

The simplest configuration uses a connection string from the Azure portal:

```yaml
receivers:
  azure_event_hub:
    connection: Endpoint=sb://<namespace>.servicebus.windows.net/;SharedAccessKeyName=<key-name>;SharedAccessKey=<key>;EntityPath=<hub-name>
    group: $Default  # optional, defaults to $Default
```

The full list of settings exposed for this receiver are documented above with detailed sample configurations in [testdata/config.yaml](./testdata/config.yaml).

### Advanced Configuration

#### Azure Auth Extension with Service Principal

```yaml
receivers:
  azure_event_hub:
    event_hub:
      name: hubName
      namespace: namespace.servicebus.windows.net
    auth: azureauth

extensions:
  azureauth:
    service_principal:
      client_id: ${env:AZURE_CLIENT_ID}
      client_secret: ${env:AZURE_CLIENT_SECRET}
      tenant_id: ${env:AZURE_TENANT_ID}
```

#### Checkpoint Persistence with Storage Extension

This component can persist its state (checkpoint offsets) using the [storage extension]. This is **strongly recommended** for production deployments to prevent message reprocessing after collector restarts.

Without a storage extension configured, the receiver will start from the latest offset on each restart, potentially missing messages that arrived while the collector was down.

```yaml
receivers:
  azure_event_hub:
    connection: Endpoint=sb://namespace.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=superSecret1234=;EntityPath=hubName
    storage: file_storage

extensions:
  file_storage:
    directory: /var/lib/otelcol/eventhub
```

#### Custom Time Formats and Partitioning

```yaml
receivers:
  azure_event_hub:
    connection: Endpoint=sb://namespace.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=superSecret1234=;EntityPath=hubName
    partition: "0"
    group: my-consumer-group
    offset: "1234-5566"
    format: "azure"
    time_formats:
      logs: ["01/02/2006 15:04:05", "2006-01-02 15:04:05"]
      metrics: ["01/02/2006 15:04:05"]
```

## Feature Gates

The following feature gates are available for this receiver:

### `receiver.azureeventhubreceiver.UseAzeventhubs`

| Status | Default | From Version | To Version |
|--------|---------|--------------|------------|
| Stable | `true`  | v0.129.0     | v0.144.0   |

## Known Limitations

Before using this receiver, be aware of the following limitations:

### Checkpoint Persistence

- Without a configured [storage extension], checkpoint state is stored only in memory. If the collector restarts, the receiver will resume from the latest offset, potentially missing messages or reprocessing already-consumed messages.

## Format

### raw

The "raw" format maps the AMQP properties and data into the
attributes and body of an OpenTelemetry LogRecord, respectively.
The body is represented as a raw byte array.

> [!WARNING]
> This format is **only supported for Logs**. Using `raw` format with Metrics or Traces pipelines will result in an error.

### azure

#### Logs

The "azure" format extracts the Azure log records from the AMQP
message data, parses them, and maps the fields to OpenTelemetry
attributes. The table below summarizes the mapping between the
[Azure common log format](https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/resource-logs-schema)
and the OpenTelemetry attributes.


| Azure                            | OpenTelemetry                          |
|----------------------------------|----------------------------------------|
| callerIpAddress (optional)       | network.peer.address (attribute)       |
| correlationId (optional)         | azure.correlation.id (attribute)       |
| category (optional)              | azure.category (attribute)             |
| durationMs (optional)            | azure.duration (attribute)             |
| Level (optional)                 | severity_number, severity_text (field) |
| location (optional)              | cloud.region (attribute)               |
| â€”                                | cloud.provider (attribute)             |
| operationName (required)         | azure.operation.name (attribute)       |
| operationVersion (optional)      | azure.operation.version (attribute)    |
| properties (optional)            | azure.properties (attribute, nested)   |
| resourceId (required)            | azure.resource.id (resource attribute) |
| resultDescription (optional)     | azure.result.description (attribute)   |
| resultSignature (optional)       | azure.result.signature (attribute)     |
| resultType (optional)            | azure.result.type (attribute)          |
| tenantId (required, tenant logs) | azure.tenant.id (attribute)            |
| time or timeStamp (required)     | time_unix_nano (time takes precedence) |
| identity (optional)              | azure.identity (attribute, nested)     |

Notes:
* JSON does not distinguish between fixed and floating point numbers. All
JSON numbers are encoded as doubles.

#### Metrics

For Metrics the Azure Metric Records are an array
of "records" with the following fields, by
[type of metric](https://learn.microsoft.com/en-us/azure/azure-monitor/metrics/data-platform-metrics#types-of-metrics).

From this data a Metric of type Gauge is created
with a Data Points that represents the values
for the Metric including: Total, Minimum, Maximum,
Average and Count.

##### Platform metric (from Azure resources)

| Azure      | Open Telemetry                              |
|------------|---------------------------------------------|
| time       | time_unix_nano (field)                      |
| resourceId | azure.resource.id (resource attribute)      |
| metricName |                                             |
| timeGrain  | start_time_unix_nano (field)                |
| total      | mapped to datapoint metricName + "_TOTAL"   |
| count      | mapped to datapoint metricName + "_COUNT"   |
| minimum    | mapped to datapoint metricName + "_MINIMUM" |
| maximum    | mapped to datapoint metricName + "_MAXIMUM" |
| average    | mapped to datapoint metricName + "_AVERAGE" |

##### Application metrics (from Application Insights)

See: https://learn.microsoft.com/en-us/azure/azure-monitor/reference/tables/appmetrics

| Azure                      | Open Telemetry                              |
|----------------------------|---------------------------------------------|
| time                       | time_unix_nano (field)                      |
| resourceId                 | azure.resource.id (resource attribute)      |
| Name                       | (metric name)                               |
| AppRoleInstance            | service.instance.id (resource attribute)    |
| AppRoleName                | service.name (resource attribute)           |
| AppVersion                 | service.version (resource attribute)        |
| SDKVersion                 | telemetry.sdk.version (resource attribute)  |
| ClientCountryOrRegion      | cloud.region (resource attribute)           |
| ClientOS                   | os.name (resource attribute)                |
| Properties (key/value map) | mapped to resource attributes               |
| Sum                        | mapped to datapoint metricName + "_TOTAL"   |
| ItemCount                  | mapped to datapoint metricName + "_COUNT"   |
| Min                        | mapped to datapoint metricName + "_MINIMUM" |
| Max                        | mapped to datapoint metricName + "_MAXIMUM" |

#### Traces

Traces based on Azure Application Insights array of records from `AppRequests` & `AppDependencies` with the following fields.

| Azure       | Open Telemetry                                        |
|-------------|-------------------------------------------------------|
| Time        | start_time(time_unix_nano(time))                      |
|             | end_time(start_time + time_unix_nano(durationMs))     |
| Name        | span.name                                             |
| OperationId | trace.id                                              |
| ParentId    | span.parentId                                         |
| Id          | span.id                                               |
| AppRoleName | service.name                                          |

[storage extension]: https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/extension/storage
